## 流程图框架LogicFlow的简单使用

哎\呀/，在外包打了半年工又被清退惹，正当我在烦恼接下去该怎么办的时候，这个时候，居然有个老同事联系上了我，他还给我介绍了兼职！真是在家靠父母、在外靠朋友啊！正当我感觉有点兴奋、跃跃欲试的时候，对接我的人、他跟我说，要做一个类似工作流的东西，我一下懵了，虽然我前面发过一些可视化的东西，但实际上呢，在可视化方面我还是比较菜的，最熟练的，就是调api，当时我就想，完了，总不会让我自己画吧，那我可不会整，要让我搞的话得搜罗一下开源库，我马上给对方打预防针，说我可视化不太有经验，没想到对方，居然很快发来一条消息，跟我说他们已经选好用滴滴的LogicFlow了，我找到官网一看，哎呀，还真不错，看上去挺好用的样子，我算是松了一口气，不过我之前没用过这个库，所以还是稍微研究了一下它的使用。

其实我们可以看到LogicFlow的使用在官网上已经介绍地比较全面了（[网页浏览ing](http://logicflow.cn/tutorial/about)），在[sandbox](https://codesandbox.io/p/sandbox/logicflow-base26-ztpvtv?file=%2Fstep_26_nodeResize%2Findex.js&from-embed)上我们能看到很多示例代码，所以我主要是研究了下怎么在React中使用。

### 初始化

首先，我们先设置一个变量用于存储Logicflow对象，这样我们就能在后续代码中去使用它。

```tsx
const lfRef = useRef(null);
```

接着我们要在页面上设置流程图的容器，用这个容器来初始化Logicflow对象。

```tsx
const containerRef = useRef(null);

useEffect(() => {
  lfRef.current = new LogicFlow({
    container: containerRef.current,
    grid: true,
    edgeType: 'bezier',
  });
},[]);
```

初始化完成就可以通过Logicflow对象的render方法将流程图绘制到页面上了。

```tsx
lfRef.current.render({});
```

在初始化的时候我们设置了`grid:true`，这个会给流程图设置网格背景，这样设置之后我们可以更直观的看到流程图已经被正确地绘制到页面上了。

`edgeType`指定了线的类型，这里我设置了使用贝塞尔曲线。

那么只有这么一个背景显然是不行的，我们肯定是希望在画布上画点东西上去，这里就有两种方式了，一种是直接通过render方法一次性画上去，另一种就是手动添加。



### 一次性绘制

首先我们来说一次性绘制。

在这里我们可以直接把官网的示例（step2）拿过来，因为一次性绘制在React项目里也并没有特别之处。

```tsx
lfRef.current.render({
  nodes: [
    {
      id: "1",
      type: "rect",
      x: 100,
      y: 100,
      text: "矩形"
    },
    {
      id: "2",
      type: "circle",
      x: 300,
      y: 100,
      text: "圆形"
    },
    {
      id: "3",
      type: "ellipse",
      x: 500,
      y: 100,
      text: "椭圆"
    },
    {
      id: "4",
      type: "polygon",
      x: 100,
      y: 250,
      text: "多边形"
    },
    {
      id: "5",
      type: "diamond",
      x: 300,
      y: 250,
      text: "菱形"
    },
    {
      id: "6",
      type: "text",
      x: 500,
      y: 250,
      text: "纯文本节点"
    },
    {
      id: "7",
      type: "html",
      x: 100,
      y: 400,
      text: "html节点"
    }
  ]
});
```

这样我们就能在页面上绘制出一堆的节点。

这里的type就是节点的类型，Logicflow里有一些内置的基础类型可以直接使用，比如我们这里展示的，当然我们也可以定义自己需要的类型进行扩展。

除了这些基础属性之外，我们还可以给节点添加`properties`属性用于存储业务场景相关的数据。



### 手动添加

在具体项目中，我们使用流程图的目的大多数情况并不是为了一次性绘制，而是为了动态添加节点，绘制我们自己自定义的流程，Logicflow当然也提供了这样的功能，我们可以通过配置`DndPanel`这个插件给流程图添加拖拽面板，让我们可以通过拖拽的操作、在页面上新建节点。

首先我们要引入`DndPanel`和样式；

```tsx
import { DndPanel } from '@logicflow/extension';
import '@logicflow/extension/lib/style/index.css';
```

然后我们把文档里的[这段内容](https://docs.logic-flow.cn/docs/#/zh/guide/extension/component-dnd-panel?id=%e4%bd%bf%e7%94%a8%e7%a4%ba%e4%be%8b)添加到我们的代码中。

可以看到，基础的使用就是这么简单。



### 自定义内容

很显然，基础类型的节点在大多数情况下是无法满足实际业务场景的，所以我们需要知道怎么自定义节点类型，在文档中我们看到[这部分内容](https://docs.logic-flow.cn/docs/#/zh/guide/basic/node?id=%e8%87%aa%e5%ae%9a%e4%b9%89%e4%b8%80%e4%b8%aa%e4%b8%9a%e5%8a%a1%e8%8a%82%e7%82%b9)实现了类型的自定义，这里使用了h函数来实现节点的渲染，`h`方法是 LogicFlow 对外暴露的渲染函数，他的用法与`react`、`vue`的[createElement](https://cn.vuejs.org/v2/guide/render-function.html#createElement-参数)一致，可以看到写起来还是有点繁琐的，既然我们在react项目中使用，那么可不可以使用jsx写呢，答案显然是可以的，翻看官网文档我们可以看到这里还给出了[例子](https://docs.logic-flow.cn/docs/#/zh/guide/basic/node?id=%e4%bd%bf%e7%94%a8-react-%e7%bc%96%e5%86%99-html-%e8%8a%82%e7%82%b9)。

我们可以把这个例子拿过来直接修修改改就可以完成针对具体项目的定制。我们来快速看下这段代码，可以看到最终这里是导出了三个属性，首先是type，这个type是指定了节点的类型名称，是一个字符串，另外两个就是具体我们要定义的view和model，这是因为Logicflow是基于MVVM模式。

我们需要在内置节点的类型上进行扩展，所以我们可以看到这里的`extends`，就是对基础类型进行扩展。

model主要用于定义和设置数据，比如与节点自身相关的几何属性、样式属性，以及与业务相关的数据，主要从数据层面去定义节点，我们可以通过只扩展model对基础类型做简单的扩展，如果想要实现更深层的外形定制化，对节点的形状进行定义，我们就需要用到view，对展现出来的、我们看到的视图进行自定义。

另外看文档这里，需要注意、自定义节点view的图形形状属性必须和model中的形状属性一致，不过我想正常情况下一般人也不会去混用吧。

整个文档其实还是挺详细的，有需要和感兴趣的同学可以自己去翻阅一下。



### 自定义面板

接着我们来看这个拖拽面板，默认的拖拽面板是预设定了一些样式，比如悬浮在左侧、如果元素过多就会溢出，当然咯，我们可以/通过给他设置额外的class来更改样式，但是！我们还可以通过自定义面板的方式来进行更灵活的定制。只要注册mousedown事件，然后去调用dnd的startDrag方法就可以实现拖拽创建节点，操作十分简单。

我们来试下这段代码。



### 右键菜单设置

最后我们看这个右键菜单，Logicflow依旧很贴心的为我们配套了`Menu`这个插件用于右键菜单的配置，直接配置上就有了，如果想要增加额外的菜单项，可以调用menu的addMenuConfig方法，如果不想要其中一些菜单项，或者是想要做一些额外的操作，也可以通过setMenuConfig方法对菜单进行自定义设置。



### 事件Event

到这里我的大部分的业务需求都满足了，就剩下一个点击去编辑节点属性的操作，其实这里的节点是有双击更改文本的默认操作，但我个人感觉、这种操作大部分情况下是不太能满足具体的业务需求和前端的视觉需求的，所以我选择把文本编辑禁用了。

Logicflow也实现了事件的监听，比如这里看到的`node:click`和`edge:click`，针对的就是节点和边的点击事件监听。

我们可以像这样，在监听到节点被点击后，弹出一个弹窗，对节点的业务数据进行查看或编辑，在编辑完数据后，接着调用`setProperties`方法，对流程图的某个节点的properties属性进行更新。



好了，到这里页面上的基本操作就差不多啦，最后就是数据的保存啦，我们可以调用`getGraphData`方法，将数据导出传给接口进行保存，这样在后续的维护中，只要后端把这个数据直接返回给前端，这个数据、前端是直接可以传给render方法进行使用的，打印出来可以看到，这个内容就是一个包含nodes和edges两个属性的对象，那么用户可以在这个基础上继续对流程图进行编辑。



真的是傻瓜式操作了，只要对流程图有过一点接触了解的人，上手应该都十分容易，当然咯我这里需求比较简单，所以使用上没什么问题。如果是有点复杂的需求，也可以再翻翻他们的文档和github主页。